syntax = "proto3";

package keel.v1;

service NodeService {
  // Get system health and status
  rpc GetStatus (GetStatusRequest) returns (GetStatusResponse);
  
  // Reboot the node (protected)
  rpc Reboot (RebootRequest) returns (RebootResponse);

  // Install an OS update to the inactive partition
  rpc InstallUpdate (InstallUpdateRequest) returns (stream UpdateProgress);
  
  // Schedule an update for a future time
  rpc ScheduleUpdate (ScheduleUpdateRequest) returns (ScheduleUpdateResponse);
  
  // Get current update schedule
  rpc GetUpdateSchedule (GetUpdateScheduleRequest) returns (GetUpdateScheduleResponse);
  
  // Cancel scheduled update
  rpc CancelScheduledUpdate (CancelScheduledUpdateRequest) returns (CancelScheduledUpdateResponse);
  
  // Get system health status
  rpc GetHealth (GetHealthRequest) returns (GetHealthResponse);
  
  // Manually trigger rollback
  rpc TriggerRollback (TriggerRollbackRequest) returns (TriggerRollbackResponse);
  
  // Get rollback history
  rpc GetRollbackHistory (GetRollbackHistoryRequest) returns (GetRollbackHistoryResponse);
  
  // Sign a client CSR with bootstrap CA (only available before K8s join)
  rpc SignBootstrapCertificate (SignBootstrapCertificateRequest) returns (SignBootstrapCertificateResponse);
  
  // Bootstrap node to Kubernetes cluster
  rpc BootstrapKubernetes (BootstrapKubernetesRequest) returns (BootstrapKubernetesResponse);
  
  // Get Kubernetes bootstrap status
  rpc GetBootstrapStatus (GetBootstrapStatusRequest) returns (GetBootstrapStatusResponse);
}

message InstallUpdateRequest {
  // Source of the SquashFS image (URL or local path)
  string source_url = 1;
  // Expected SHA256 checksum (optional)
  string expected_sha256 = 2;
  
  // Delta update support
  bool is_delta = 3;
  bool fallback_to_full = 4;  // If delta fails, try full image
  string full_image_url = 5;   // URL for fallback full image
}

message UpdateProgress {
  uint32 percentage = 1;
  string message = 2;
  bool success = 3;
  // Optional: Estimated time remaining in seconds
  uint32 eta_seconds = 4;
  // Optional: Download speed in bytes/sec
  uint64 download_speed_bps = 5;
  
  // Delta-specific info
  string phase = 6;  // "downloading", "patching", "verifying"
  uint64 bytes_saved = 7;  // Bandwidth saved vs full download
}

message GetStatusRequest {}

message GetStatusResponse {
  string hostname = 1;
  string kernel_version = 2;
  string os_version = 3;
  float uptime_seconds = 4;
}

message RebootRequest {
  // Reason for reboot (audit log)
  string reason = 1;
}

message RebootResponse {
  bool scheduled = 1;
}

// Scheduling messages

message ScheduleUpdateRequest {
  string source_url = 1;
  string expected_sha256 = 2;
  
  // Optional: Schedule for specific time (RFC3339 format)
  string scheduled_at = 3;
  
  // Optional: Maintenance window duration in seconds
  uint32 maintenance_window_secs = 4;
  
  // Optional: Enable auto-rollback on failure
  bool enable_auto_rollback = 5;
  
  // Optional: Health check timeout in seconds (default: 300)
  uint32 health_check_timeout_secs = 6;
  
  // Optional: Pre-update hook command
  string pre_update_hook = 7;
  
  // Optional: Post-update hook command
  string post_update_hook = 8;
  
  // Delta update support
  // Delta update support
  bool is_delta = 9;
  bool fallback_to_full = 10;
  string full_image_url = 11;
}

message ScheduleUpdateResponse {
  string schedule_id = 1;
  string status = 2;
  string scheduled_at = 3;
}

message GetUpdateScheduleRequest {}

message GetUpdateScheduleResponse {
  repeated UpdateSchedule schedules = 1;
}

message UpdateSchedule {
  string id = 1;
  string source_url = 2;
  string expected_sha256 = 3;
  string scheduled_at = 4;
  string status = 5; // pending, running, completed, failed, cancelled
  bool enable_auto_rollback = 6;
  string created_at = 7;
}

message CancelScheduledUpdateRequest {
  string schedule_id = 1;
}

message CancelScheduledUpdateResponse {
  bool success = 1;
  string message = 2;
}

// Health check messages

message GetHealthRequest {}

message GetHealthResponse {
  string status = 1; // "healthy", "degraded", "unhealthy"
  repeated HealthCheckResult checks = 2;
  string last_update_time = 3;
}

message HealthCheckResult {
  string name = 1;
  string status = 2; // "pass", "fail", "unknown"
  string message = 3;
  uint64 duration_ms = 4;
}

// Rollback messages

message TriggerRollbackRequest {
  string reason = 1;
}

message TriggerRollbackResponse {
  bool success = 1;
  string message = 2;
}

message GetRollbackHistoryRequest {}

message GetRollbackHistoryResponse {
  repeated RollbackEvent events = 1;
}

message RollbackEvent {
  string timestamp = 1;
  string reason = 2;
  string from_partition = 3;
  string to_partition = 4;
  bool automatic = 5;
}

// Bootstrap certificate signing messages

message SignBootstrapCertificateRequest {
  // Client's Certificate Signing Request in PEM format
  string csr_pem = 1;
}

message SignBootstrapCertificateResponse {
  // Signed client certificate in PEM format
  string client_cert_pem = 1;
  // Bootstrap CA certificate in PEM format
  string ca_cert_pem = 2;
}

// Kubernetes Bootstrap messages

message BootstrapKubernetesRequest {
  // Kubernetes API server endpoint (e.g., "https://k8s.example.com:6443")
  string api_server_endpoint = 1;
  
  // Bootstrap token for TLS bootstrapping (format: <token-id>.<token-secret>)
  // Optional if kubeconfig is provided
  string bootstrap_token = 2;
  
  // Cluster CA certificate in PEM format
  // Required for token-based auth, optional if kubeconfig contains CA
  string ca_cert_pem = 3;
  
  // Full kubeconfig content as bytes (alternative to token-based auth)
  // If provided, bypasses token authentication
  bytes kubeconfig = 4;
  
  // Override node name (default: hostname)
  string node_name = 5;
}

message BootstrapKubernetesResponse {
  bool success = 1;
  string message = 2;
  // Path where kubeconfig was written
  string kubeconfig_path = 3;
}

message GetBootstrapStatusRequest {}

message GetBootstrapStatusResponse {
  // Whether node has been bootstrapped to a cluster
  bool is_bootstrapped = 1;
  
  // API server endpoint if bootstrapped
  string api_server_endpoint = 2;
  
  // Node name in the cluster
  string node_name = 3;
  
  // Path to kubeconfig file
  string kubeconfig_path = 4;
  
  // Bootstrap timestamp (RFC3339)
  string bootstrapped_at = 5;
}
