name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # FAST CHECKS - Run in parallel
  # ============================================================================
  
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install Protobuf Compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: lint-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy Lints
        run: cargo clippy --workspace -- -D warnings

      - name: Check Formatting
        run: cargo fmt --all -- --check

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run Security Audit
        run: cargo audit

  # ============================================================================
  # BUILD - Produces artifacts for parallel test jobs
  # ============================================================================
  
  build:
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('tools/builder/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Cargo Registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache Kernel Sources
        uses: actions/cache@v4
        with:
          path: .cache/kernel
          key: ${{ runner.os }}-kernel-sources
          restore-keys: |
            ${{ runner.os }}-kernel-sources

      - name: Cache Built Kernel
        uses: actions/cache@v4
        with:
          path: build/kernel
          key: ${{ runner.os }}-kernel-build-${{ hashFiles('tools/builder/kernel-build.sh', 'tools/builder/kernel-config') }}
          restore-keys: |
            ${{ runner.os }}-kernel-build-

      - name: Build Builder Image
        uses: docker/build-push-action@v5
        with:
          context: ./tools/builder
          push: false
          load: true
          tags: keelos-builder:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Build All Components
        run: |
          mkdir -p target .cache/kernel build
          docker run --rm \
            -v ${{ github.workspace }}:/keelos \
            -v ~/.cargo/registry:/root/.cargo/registry \
            -v ~/.cargo/git:/root/.cargo/git \
            --privileged \
            keelos-builder:latest \
            /keelos/tools/ci-build-only.sh

      - name: Run Unit Tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/keelos \
            -v ~/.cargo/registry:/root/.cargo/registry \
            -v ~/.cargo/git:/root/.cargo/git \
            keelos-builder:latest \
            cargo test --workspace

      - name: Fix Permissions
        if: always()
        run: |
          sudo chown -R $USER:$USER target ~/.cargo .cache build || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: keelos-build
          path: |
            build/kernel/bzImage
            build/initramfs.cpio.gz
            build/sda.img
            build/keelos.iso
            build/osctl
          retention-days: 1

  # ============================================================================
  # TESTS - Run in parallel after build completes
  # ============================================================================

  test-boot:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: keelos-build
          path: build/

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86

      - name: Run Boot Test
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/test-boot.sh

  test-integration:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: keelos-build
          path: build/

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86

      - name: Run Integration Test
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/test-integration.sh

  test-network:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: keelos-build
          path: build/

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86

      - name: Run Network Integration Test
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/test-network.sh

  test-bootstrap-kind:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: keelos-build
          path: build/

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Protobuf Compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install QEMU
        run: sudo apt-get install -y qemu-system-x86

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Make osctl executable
        run: chmod +x build/osctl

      - name: Run Bootstrap Test
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/test-bootstrap-kind.sh

      - name: Cleanup
        if: always()
        run: kind delete cluster --name keel-test || true


  test-artifacts:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: keelos-build
          path: build/

      - name: Verify Artifacts
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/verify-artifacts.sh
