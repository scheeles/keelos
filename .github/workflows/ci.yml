name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # FAST CHECKS - Run in parallel
  # ============================================================================
  
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install Protobuf Compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: lint-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy Lints
        run: cargo clippy --workspace -- -D warnings

      - name: Check Formatting
        run: cargo fmt --all -- --check

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-audit
        uses: actions/cache@v4
        id: cache-cargo-audit
        with:
          path: ~/.cargo/bin/cargo-audit
          key: ${{ runner.os }}-cargo-audit-${{ hashFiles('.github/workflows/ci.yml') }}

      - name: Install cargo-audit
        if: steps.cache-cargo-audit.outputs.cache-hit != 'true'
        run: cargo install cargo-audit

      - name: Run Security Audit
        run: cargo audit

  # ============================================================================
  # BUILD - Produces artifacts for parallel test jobs
  # ============================================================================
  
  build:
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "."
          cache-on-failure: true

      - name: Cache Kernel Sources
        uses: actions/cache@v4
        with:
          path: .cache/kernel
          key: ${{ runner.os }}-kernel-sources
          restore-keys: |
            ${{ runner.os }}-kernel-sources

      - name: Cache Built Kernel
        uses: actions/cache@v4
        with:
          path: build/kernel
          key: ${{ runner.os }}-kernel-build-${{ hashFiles('tools/builder/kernel-build.sh', 'tools/builder/kernel-config') }}
          restore-keys: |
            ${{ runner.os }}-kernel-build-

      - name: Pull or Build Builder Image
        env:
          REGISTRY: ghcr.io
          IMAGE_NAME: ${{ github.repository }}/maticos-builder
        run: |
          # Try to pull from GHCR first
          if docker pull $REGISTRY/$IMAGE_NAME:latest 2>/dev/null; then
            docker tag $REGISTRY/$IMAGE_NAME:latest maticos-builder:latest
            echo "✓ Using published builder image from GHCR"
          else
            # Fallback to building locally
            echo "⚠ Published image not found, building locally"
            docker build -t maticos-builder:latest ./tools/builder
          fi

      - name: Build All Components
        run: |
          mkdir -p target .cache/kernel build
          docker run --rm \
            -v ${{ github.workspace }}:/maticos \
            -v ~/.cargo/registry:/root/.cargo/registry \
            -v ~/.cargo/git:/root/.cargo/git \
            --privileged \
            maticos-builder:latest \
            /maticos/tools/ci-build-only.sh



      - name: Fix Permissions
        if: always()
        run: |
          sudo chown -R $USER:$USER target ~/.cargo .cache build || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maticos-build
          path: |
            build/kernel/bzImage
            build/initramfs.cpio.gz
            build/sda.img
            build/maticos.iso
          retention-days: 1

  # ============================================================================
  # TESTS - Run in parallel after build completes
  # ============================================================================

  test-unit:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Protobuf Compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Run Unit Tests
        run: cargo test --workspace

  test-boot:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: maticos-build
          path: build/

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86

      - name: Run Boot Test
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/test-boot.sh

  test-integration:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: maticos-build
          path: build/

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86

      - name: Run Integration Test
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/test-integration.sh

  test-artifacts:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: maticos-build
          path: build/

      - name: Verify Artifacts
        run: |
          chmod +x tools/testing/*.sh
          ./tools/testing/verify-artifacts.sh
